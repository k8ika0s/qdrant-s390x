# s390x (IBM Z / zLinux) Support

This repository contains ongoing work to make Qdrant build, test, and run on `s390x` (big-endian).

## Compatibility Goals

- Build from source on `s390x-unknown-linux-gnu`.
- Run the core service (`qdrant`) with RocksDB enabled.
- Keep persisted formats architecture-neutral (see `docs/PERSISTENCE_ENDIANNESS.md`).
- Provide regression coverage that prevents reintroducing endian-dependent persistence.

## CI Signals

Current CI provides two informational s390x lanes:

- `s390x check`: `cargo check -p qdrant --target s390x-unknown-linux-gnu`
- `s390x unit tests (qemu)`: runs a curated set of tests under `cross` + QEMU

These jobs are intentionally `continue-on-error` while the signal is being stabilized.

### Promotion Criteria (Informational -> Required)

Suggested promotion criteria (to keep review friction low while avoiding “forever-informational”):

- Phase 0 (today): `continue-on-error` while we harden the lane and eliminate flakes.
- Phase 1: make `s390x check` required (fast compile signal; should be stable).
- Phase 2: make `s390x unit tests (qemu)` required once:
  - the curated test set stays green on the default branch for a sustained period, and
  - job runtime is within an acceptable envelope for normal PR cadence, and
  - failures are actionable (not infra noise).

### Known Limitations

- The QEMU lane intentionally runs a small “high-signal” subset. It is not expected to cover the full
  `segment` test suite or any long-running end-to-end scenarios.
- Native s390x hosts remain the source of truth for final validation before declaring a change
  “s390x-ready” (see the native gate sweep below).
- Runtime budget (guideline):
  - `s390x check`: keep it “quick” (single-digit minutes on GitHub runners).
  - `s390x unit tests (qemu)`: keep it bounded (avoid adding broad workspace tests; prefer targeted
    filters like `segment endian` and the routing determinism test).

## Native Validation Gates

For native hosts (recommended for final validation), use:

```bash
tools/run-s390x-gates.sh
```

This writes per-stage logs under `dev-docs/s390x-validation/` by default.

### “s390x-ready” Gate Conditions

We consider a change “s390x-ready” when the following are true:

- `cargo check -p qdrant --target s390x-unknown-linux-gnu --locked` succeeds (CI `s390x check` lane).
- The curated QEMU test slice stays green (CI `s390x unit tests (qemu)` lane).
- A native s390x host run of `tools/run-s390x-gates.sh` completes with `rc=0` for all stages.

For changes that touch persistence formats, also require:

- Explicit endian-safe persistence (see `docs/PERSISTENCE_ENDIANNESS.md`) plus targeted regression tests.
- At least one negative test that rejects malformed/truncated input for any new/modified decode path.

### Cross-Endian Snapshot Fixtures (Optional, High Signal)

For deeper portability validation (LE -> BE and BE -> LE), use the ignored fixture tests:

- Producer (run on the source architecture, writes a fixture directory):
  ```bash
  S390X_FIXTURES_DIR=dev-docs/s390x-fixtures/le-run \
    cargo test -p qdrant --features rocksdb --locked --test s390x_snapshot_fixture_matrix \
    -- --ignored s390x_snapshot_fixture_produce
  ```
- Copy the resulting directory to the other architecture.
- Consumer (run on the target architecture, restores and validates all fixtures in the directory):
  ```bash
  S390X_FIXTURES_DIR=/path/to/copied/fixtures \
    cargo test -p qdrant --features rocksdb --locked --test s390x_snapshot_fixture_matrix \
    -- --ignored s390x_snapshot_fixture_consume
  ```

If `S390X_FIXTURES_DIR` is set, `tools/run-s390x-gates.sh` will also run the consumer as part of the
native gate sweep.

Notes:

- Some stages are link- and disk-heavy. On shared/limited hosts, consider `CARGO_BUILD_JOBS=2` and
  ensure sufficient free disk space before running full workspace builds/tests.
- The gate sweep includes an ignored end-to-end HTTP smoke test (`tests/s390x_http_smoke.rs`) that:
  - boots Qdrant,
  - creates a collection and upserts points,
  - restarts Qdrant and re-queries persisted data.
  You can run it directly with:
  ```bash
  cargo test -p qdrant --features rocksdb --locked --test s390x_http_smoke -- --ignored
  ```
- The gate sweep also includes an ignored snapshot create/restore test (`tests/s390x_snapshot_smoke.rs`)
  that creates a collection snapshot and restores it into a fresh storage path:
  ```bash
  cargo test -p qdrant --features rocksdb --locked --test s390x_snapshot_smoke -- --ignored
  ```

## Persistence Hygiene

When touching a persisted on-disk format:

1. Follow `docs/PERSISTENCE_ENDIANNESS.md` (canonical little-endian persistence).
2. Add or bump a version marker where practical.
3. Add migration/compatibility tests (including malformed-input tests).
4. Optionally run:

```bash
tools/check-persistence-endianness.sh <touched-file>...
```

This is a heuristic helper intended to catch obvious mistakes early.

## Cluster Routing and Mixed-Endian Notes

Cluster routing is based on a stable hashing layer (`common::stable_hash`) which encodes numeric
types in canonical **little-endian** form before hashing. This ensures shard routing decisions are
architecture-independent and enables mixed-endian clusters (LE + BE) in principle.

Operational guidance:

- For safety, treat mixed-endian clusters as supported only when **all nodes run a build that
  includes the stable-hash canonicalization work**.
- If you need to validate routing stability, run the `collection` crate test:
  `cargo test -p collection test_routing_is_stable_across_architectures`.
